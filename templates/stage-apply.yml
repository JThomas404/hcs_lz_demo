# # Applies the previously generated plan artifact through a gated deployment environment.
# parameters:
#   - name: environment
#     type: string
#     default: "dev"
#   - name: path
#     type: string
#     default: "./"

# jobs:
#   - deployment: terraform_apply
#     displayName: "Terragrunt apply (pipeline-only)"
#     environment: ${{ parameters.environment }}
#     pool:
#       vmImage: "ubuntu-latest"
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#             - checkout: self
#             - download: current
#               artifact: tfplan
#             - download: current
#               artifact: tfplan-json
#             - script: |
#                 set -euo pipefail
#                 echo "Installing terragrunt for apply"
#                 sudo apt-get update -y
#                 sudo apt-get install -y curl coreutils
#                 TG_VERSION="0.55.12"
#                 TG_BASE_URL="https://github.com/gruntwork-io/terragrunt/releases/download/v${TG_VERSION}"
#                 TG_BIN_URL="${TG_BASE_URL}/terragrunt_linux_amd64"
#                 TG_SUM_URL="${TG_BASE_URL}/SHA256SUMS"
#                 curl -fsSL "${TG_BIN_URL}" -o /tmp/terragrunt_linux_amd64
#                 curl -fsSL "${TG_SUM_URL}" -o /tmp/terragrunt_SHA256SUMS
#                 grep " terragrunt_linux_amd64$" /tmp/terragrunt_SHA256SUMS > /tmp/terragrunt_sha_check
#                 sed -i 's| terragrunt_linux_amd64$|  /tmp/terragrunt_linux_amd64|' /tmp/terragrunt_sha_check
#                 sha256sum -c /tmp/terragrunt_sha_check
#                 sudo mv /tmp/terragrunt_linux_amd64 /usr/local/bin/terragrunt
#                 sudo chmod +x /usr/local/bin/terragrunt
#               displayName: "Install terragrunt"
#             - script: |
#                 set -euo pipefail
#                 echo "Setting HCS credentials from pipeline variables"
#                 export TF_VAR_hcs_access_key="$(TF_VAR_hcs_access_key)"
#                 export TF_VAR_hcs_secret_key="$(TF_VAR_hcs_secret_key)"
#                 # Ensure apply runs in the intended stack directory.
#                 cd "$(Build.SourcesDirectory)/${{ parameters.path }}"
#                 # The plan artifact is downloaded into the pipeline workspace under tfplan/
#                 if [ -f "$(Pipeline.Workspace)/tfplan/tfplan" ]; then
#                   echo "Applying terragrunt plan"
#                   terragrunt apply -input=false -auto-approve "$(Pipeline.Workspace)/tfplan/tfplan"
#                 else
#                   echo "Plan artifact not found; aborting apply"
#                   exit 1
#                 fi
#               displayName: "terragrunt apply from plan"
